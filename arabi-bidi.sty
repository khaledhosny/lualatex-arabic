% Copyright (C) 2009 by Khaled Hosny <khaledhosny@eglug.org>
% 
% This work is under the CC0 license.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{arabi-bidi}
  [2009/04/29 v0.5  Bidirectional typesetting package for LuaTeX]

\RequirePackage{luatextra}
\RequirePackage{ifluatex}

\ifluatex
\else
   \newlinechar`\^^J
   \typeout{^^JTo avoid this error message,^^J%
     run LuaTeX engine instead of regular TeX.^^J}
   \errmessage{Right-to-Left Support Error: use LuaTeX engine}%
\fi


\def\@text@dir#1{\textdir #1}
\def\@para@dir#1{\pardir #1}
\def\@math@dir#1{\mathdir #1}
\def\@switch@dir#1{\pagedir #1\bodydir #1\pardir #1\textdir #1}


\newif\if@rl
\def\LR#1{{\@rlfalse\@text@dir{TLT}#1}}
\def\RL#1{{\@rltrue\@text@dir{TRT}#1}}
\def\setRL{\@rltrue\@switch@dir{TRT}}
\def\setLR{\@rlfalse\@switch@dir{TLT}}
\newenvironment{rltext}{\@rltrue\@para@dir{TRT}\@text@dir{TRT}}{}
\newenvironment{lrtext}{\@rlfalse\@para@dir{TLT}\@text@dir{TLT}}{}


\luaUseModule{arabi}


\def\@sect#1#2#3#4#5#6[#7]#8{%
  \ifnum #2>\c@secnumdepth
    \let\@svsec\@empty
  \else
    \refstepcounter{#1}%
    \protected@edef\@svsec{\@seccntformat{#1}\relax}%
  \fi
  \@tempskipa #5\relax
  \ifdim \@tempskipa>\z@
    \begingroup
      #6{%
        \@hangfrom{\hskip #3\relax\@svsec}%
          \interlinepenalty \@M #8\@@par}%
    \endgroup
    \csname #1mark\endcsname{#7}%
    \addcontentsline{toc}{#1}{%
      \ifnum #2>\c@secnumdepth \else
        \protect\numberline{\csname the#1\endcsname}%
      \fi
      \if@rl{\@text@dir{TRT}#7}%
      \else{\@text@dir{TLT}#7}\fi}%
  \else
    \def\@svsechd{%
      #6{\hskip #3\relax
      \@svsec #8}%
      \csname #1mark\endcsname{#7}%
      \addcontentsline{toc}{#1}{%
        \ifnum #2>\c@secnumdepth \else
          \protect\numberline{\csname the#1\endcsname}%
        \fi
        #7}}%
  \fi
  \@xsect{#5}}


\def\@tabular{\leavevmode \hbox \bgroup \if@rl\@math@dir{TRT}\fi $\let\@acol\@tabacol
   \let\@classz\@tabclassz
   \let\@classiv\@tabclassiv \let\\\@tabularcr\@tabarray}


\newif\if@rlmath

\def\@my@startmath{\if@rl\if@rlmath\bgroup\@math@dir{TRT}\fi\fi$}
\def\@my@stopmath{$\if@rl\if@rlmath\egroup\fi\fi}
\def\@my@startdisplaymath{\if@rl\if@rlmath\bgroup\@math@dir{TRT}\fi\fi$$}
\def\@my@stopdisplaymath{$$\if@rl\if@rlmath\egroup\fi\fi}
\def\({\relax\ifmmode\@badmath\else\@my@startmath\fi}
\def\){\relax\ifmmode\ifinner\@my@stopmath\else\@badmath\fi\else \@badmath\fi}
\def\[{%
   \relax\ifmmode
      \@badmath
   \else
      \ifvmode
         \nointerlineskip
         \makebox[.6\linewidth]{}%
      \fi
      \@my@startdisplaymath%%$$ BRACE MATCH HACK
   \fi
}
\def\]{%
   \relax\ifmmode
      \ifinner
         \@badmath
      \else
         \@my@stopdisplaymath%%$$ BRACE MATCH HACK
      \fi
   \else
      \@badmath
   \fi
   \ignorespaces
}

\def\@seccntformat#1{{%
\if@rl%
  \@text@dir{TRT}%
\else%
  \@text@dir{TLT}%
\fi%
\csname the#1\endcsname\quad}}


\DeclareOption{rldocument} {\@switch@dir{TRT}\@rltrue}
\DeclareOption{rlmath} {\@rlmathtrue}
\ProcessOptions\relax

\endinput
